<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6 text-center">Pricing Plans for <%= @organization.name %></h1>
  <p class="text-center text-lg mb-2">
    Current Plan:
    <span class="badge badge-lg <%= @organization.plan.present? ? 'badge-success' : 'badge-ghost' %>">
      <%= @organization.current_stripe_plan_id.presence&.titleize || "Not Subscribed" %>
    </span>
  </p>
  <%# Removed Stripe Customer ID display %>
  <%# if @organization.stripe_customer_id.present? %>
  <%#   <p class="text-center text-sm text-base-content/70 mb-10"> %>
  <%#     Stripe Customer ID: <%= @organization.stripe_customer_id %>
  <%#   </p> %>
  <%# <% end %>

  <% if @plans.blank? && flash[:alert].blank? %>
    <div class="text-center p-6 bg-base-200 rounded-box">
      <p class="text-xl">No pricing plans are currently available.</p>
      <p class="text-base-content/70">Please check back later or contact support.</p>
    </div>
  <% elsif @plans.present? %>
    <div class="grid grid-cols-1 md:grid-cols-<%= @plans.size == 2 ? '2' : '3' %> gap-6">
      <% @plans.each do |plan_data| %>
        <%
          # The `plan_data` is now a hash we constructed in the controller.
          # It contains :id (local symbol like :starter), :stripe_plan_id, :name, :amount etc.
          # The stripe-rails helpers usually expect the local plan symbol or the Stripe::Plan object.
          # Let's assume we can pass the local symbol `plan_data[:id]` to the helper.
          # Or, if Stripe::Plans.all was directly passed as @plans, it would be plan.id (symbol)

          card_classes = ["border-2"]
          card_classes << (plan_data[:popular] ? "border-primary shadow-xl" : "border-base-300")
          
          # Update current plan check to use active_subscription? and current_stripe_plan_id
          is_active_subscription = @organization.active_subscription?
          is_current_plan = is_active_subscription && @organization.current_stripe_plan_id == plan_data[:stripe_plan_id]
        %>
        <%= render UI::CardComponent.new(title: plan_data[:name], class: card_classes.join(" ")) do |card| %>
          <% card.with_body do %>
            <div class="flex flex-col h-full">
              <% if plan_data[:popular] %>
                <div class="badge badge-primary badge-outline absolute top-4 right-4">Most Popular</div>
              <% end %>

              <% if plan_data[:amount].nil? && plan_data[:contact_us] %>
                <p class="text-4xl font-bold mb-2">Custom</p>
              <% else %>
                <p class="text-4xl font-bold mb-2">
                  <%= number_to_currency(plan_data[:amount].to_f / 100, unit: plan_data[:currency].upcase, precision: (plan_data[:amount] % 100 == 0 ? 0 : 2)) %>
                  <span class="text-xl font-normal">/<%= plan_data[:interval] %></span>
                </p>
              <% end %>

              <p class="text-base-content/70 mb-4 flex-grow"><%= plan_data[:description] %></p>
              <ul class="list-disc list-inside mb-6 space-y-1 text-sm flex-grow">
                <% plan_data[:features]&.each do |feature| %>
                  <li><%= feature %></li>
                <% end %>
              </ul>
              <div class="card-actions justify-center mt-auto">
                <% if is_current_plan %>
                  <button class="btn btn-primary btn-disabled w-full">Current Plan</button>
                <% elsif plan_data[:contact_us] %>
                  <%# Link to a contact page or mailto for Enterprise plans %>
                  <%= link_to plan_data[:checkout_button_label] || "Contact Us", "#contact-enterprise", class: "btn btn-accent w-full" %>
                <% else %>
                  <%# Use stripe-rails helper. The exact helper and options might vary. %>
                  <%# Link to our new controller action that creates a Stripe Checkout session %>
                  <%= link_to plan_data[:checkout_button_label] || "Choose Plan",
                                new_subscription_checkout_session_path(plan_id: plan_data[:stripe_plan_id]),
                                class: "btn btn-primary w-full",
                                "data-turbo": "false" # Important for Stripe redirect
                                %>
                <% end %>
              </div>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <%# Flash messages for checkout success/cancel will be handled by the controller's render of this page %>
</div>